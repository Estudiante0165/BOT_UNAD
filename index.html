<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Chatbot para Clientes</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Icono -->
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712105.png" type="image/png">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #040c18;
            color: #ffffff;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* WELCOME SCREEN */
        #welcome-screen {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: linear-gradient(135deg, #0a1124, #02050d);
            text-align: center;
            transition: opacity 0.4s ease-in-out;
        }

        #welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #welcome-screen h1 {
            font-size: 42px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        #welcome-screen p {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        #start-button {
            padding: 12px 35px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: #007bff;
            color: #ffffff;
            transition: transform 0.2s, background 0.3s;
        }

        #start-button:hover {
            transform: scale(1.05);
            background: #0056cc;
        }

        /* MAIN APP CONTAINER */
        #app-container {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s ease-in-out;
        }

        #app-container.visible {
            opacity: 1;
            pointer-events: all;
        }

        /* HEADER */
        header {
            background: #0c1326;
            padding: 18px;
            font-size: 22px;
            font-weight: 600;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: opacity 0.4s ease;
        }

        /* CHAT WINDOW */
        #chat-window {
            height: 80vh;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            background: #040c18;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* MESSAGE BUBBLES */
        .message {
            display: flex;
            width: 100%;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .user-message {
            justify-content: flex-end;
        }

        .bubble {
            max-width: 75%;
            padding: 14px 20px;
            border-radius: 14px;
            font-size: 16px;
            line-height: 22px;
            background: #112240;
            color: white;
            animation: fadeInUp 0.25s ease-out;
        }

        .user-message .bubble {
            background: #007bff;
        }

        /* TYPING INDICATOR */
        .typing-indicator {
            display: flex;
            gap: 6px;
            padding: 10px 18px;
            background: #112240;
            border-radius: 14px;
            width: fit-content;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            opacity: 0.4;
            animation: blink 1.4s infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0% {
                opacity: 0.3;
                transform: translateY(0px);
            }

            50% {
                opacity: 1;
                transform: translateY(-3px);
            }

            100% {
                opacity: 0.3;
                transform: translateY(0px);
            }
        }

        /* INPUT AREA */
        #chat-input-form {
            display: flex;
            padding: 15px;
            background: #0c1326;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        #chat-input {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            border: none;
            outline: none;
            font-size: 16px;
            background: #112240;
            color: white;
        }

        #send-button {
            margin-left: 10px;
            padding: 14px 22px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }

        #send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>

    <!-- WELCOME SCREEN -->
    <div id="welcome-screen">
        <h1>Bienvenido</h1>
        <p>Configura tu asistente virtual para atender clientes automáticamente.</p>
        <button id="start-button">Comenzar</button>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container">

        <!-- HEADER -->
        <header>
            <span id="header-title">Asistente Virtual</span>
        </header>

        <!-- CHAT WINDOW -->
        <div id="chat-window"></div>

        <!-- INPUT FORM -->
        <form id="chat-input-form">
            <input id="chat-input" type="text" placeholder="Escribe tu mensaje..." autocomplete="off" />
            <button id="send-button" type="submit">Enviar</button>
        </form>

    </div>
<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // ⛔ NO expongas la API KEY si vas a publicar en GitHub
    // Usa variables de entorno o un backend real
    const API_KEY = "AIzaSyBE7Vn63sS9ZkfdyCnJwUaNF1DJ4agDDIg";

    // Inicializar cliente correcto
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    // DOM
    const welcomeScreen = document.getElementById('welcome-screen');
    const startButton = document.getElementById('start-button');
    const appContainer = document.getElementById('app-container');
    const chatWindow = document.getElementById('chat-window');
    const chatInputForm = document.getElementById('chat-input-form');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const headerTitle = document.getElementById('header-title');

    // Estados
    const SETUP = {
        PRODUCT_NAME: "PRODUCT_NAME",
        PRICE: "PRICE",
        DETAILS: "DETAILS",
        COMPANY: "COMPANY",
        READY: "READY"
    };

    let state = SETUP.PRODUCT_NAME;
    const product = {};
    let history = [];

    // Funciones UI
    function addMessage(text, sender, html = false) {
        const m = document.createElement("div");
        m.className = `message ${sender}-message`;

        const b = document.createElement("div");
        b.className = "bubble";

        if (html) b.innerHTML = text;
        else b.textContent = text;

        m.appendChild(b);
        chatWindow.appendChild(m);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function disableInput() {
        chatInput.disabled = true;
        sendButton.disabled = true;
    }

    function enableInput() {
        chatInput.disabled = false;
        sendButton.disabled = false;
        chatInput.focus();
    }

    function showTyping() {
        const t = document.createElement("div");
        t.id = "typing";
        t.className = "message bot-message";
        t.innerHTML = "<div class='bubble'>...</div>";
        chatWindow.appendChild(t);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function hideTyping() {
        const t = document.getElementById("typing");
        if (t) t.remove();
    }

    // Preguntas iniciales
    const setupQuestions = {
        PRODUCT_NAME: "¡Hola! ¿Cuál es el nombre del producto que venderás?",
        PRICE: (p) => `Perfecto. ¿Cuál será el precio de ${p}?`,
        DETAILS: "Muy bien. Dame una descripción del producto.",
        COMPANY: "Excelente. ¿Cómo se llama tu empresa y a qué se dedica?",
        READY: "¡Listo! El chatbot ya está configurado. Pregúntame lo que desees."
    };

    // Lógica del setup
    async function handleSetup(input) {
        switch (state) {
            case SETUP.PRODUCT_NAME:
                product.name = input;
                state = SETUP.PRICE;
                addMessage(setupQuestions.PRICE(product.name), "bot");
                break;

            case SETUP.PRICE:
                product.price = input;
                state = SETUP.DETAILS;
                addMessage(setupQuestions.DETAILS, "bot");
                break;

            case SETUP.DETAILS:
                product.details = input;
                state = SETUP.COMPANY;
                addMessage(setupQuestions.COMPANY, "bot");
                break;

            case SETUP.COMPANY:
                product.company = input;
                state = SETUP.READY;

                headerTitle.textContent = `${product.name} — Soporte`;

                addMessage(setupQuestions.READY, "bot");
                break;
        }
    }

    // IA final para clientes
    async function askAI(input) {
        const system = `
Eres un chatbot de soporte amigable.
Solo responde usando la siguiente información
y NO inventes datos:

Empresa: ${product.company}

Producto:
- Nombre: ${product.name}
- Precio: ${product.price}
- Descripción: ${product.details}
`;

        const prompt = system + "\nUsuario: " + input;

        const result = await model.generateContent(prompt);
        return result.response.text();
    }

    // Iniciar app
    startButton.addEventListener("click", () => {
        welcomeScreen.style.display = "none";
        appContainer.style.display = "flex";

        addMessage(setupQuestions.PRODUCT_NAME, "bot");
    });

    // Enviar mensaje
    chatInputForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;

        addMessage(text, "user");
        chatInput.value = "";
        disableInput();
        showTyping();

        // Setup o modo chatbot
        if (state !== SETUP.READY) {
            await handleSetup(text);
        } else {
            const answer = await askAI(text);
            addMessage(answer, "bot");
        }

        hideTyping();
        enableInput();
    });
</script>
